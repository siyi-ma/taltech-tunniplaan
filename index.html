<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalTech kursused sügis 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Proxima Nova', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; line-height: 1.4; }
        .proxima-nova-bold { font-weight: 700; }
        .tt-dark-blue { color: #342b60; }
        .bg-tt-dark-blue { background-color: #342b60; }
        .hover\:bg-tt-dark-blue-hover:hover { background-color: #2a224d; }
        .tt-light-blue { color: #4dbed2; }
        .bg-tt-light-blue { background-color: #4dbed2; }
        .border-tt-light-blue { border-color: #4dbed2; }
        .tt-grey-1 { color: #9396b0; }
        .border-tt-grey-1 { border-color: #9396b0; }
        .tt-magenta { color: #e4067e; }
        .bg-tt-magenta { background-color: #e4067e; }
        .border-tt-magenta { border-color: #e4067e; }
        .focus\:ring-tt-magenta:focus { --tw-ring-color: #e4067e; }
        .text-tt-magenta { color: #e4067e; }
        .accent-tt-magenta { accent-color: #e4067e; }
        .tt-grey-2 { color: #dadae4; }
        .bg-tt-grey-2 { background-color: #dadae4; }

        .headline { font-family: 'Proxima Nova', sans-serif; font-weight: 700; text-transform: uppercase; }
        .body-text { font-family: 'Proxima Nova', sans-serif; font-weight: 400; text-transform: none; }

        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem; /* 14px */
            font-weight: normal;
            text-transform: none;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        #filterPanel {
            transition: transform 0.3s ease-in-out;
        }
        .filter-drawer-open {
            transform: translateX(0) !important;
        }
        #suggestionsContainer::-webkit-scrollbar {
            width: 8px;
        }
        #suggestionsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #suggestionsContainer::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        #suggestionsContainer::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        .suggestion-highlight {
            font-weight: 700; 
        }
        .filter-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #e9ecef; 
            color: #495057; 
            border-radius: 9999px; 
            font-size: 0.875rem;
            border: 1px solid #ced4da; 
        }
        .filter-pill-remove {
            margin-left: 0.5rem;
            background: none;
            border: none;
            color: #6c757d; 
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .filter-pill-remove:hover {
            color: #343a40; 
        }
    </style>
</head>
<body class="bg-white text-black body-text">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-tt-dark-blue text-white p-4 shadow-md">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <button id="filterToggleButton" class="mr-4 p-2 text-white hover:bg-tt-dark-blue-hover rounded" aria-label="Ava filtrid">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h1 id="pageTitle" class="text-2xl proxima-nova-bold uppercase">TalTech kursused kevad 2025</h1>
            </div>
            <button id="languageToggle" class="p-2 bg-tt-magenta hover:bg-opacity-80 rounded" aria-label="Switch language">
                <i class="fas fa-globe"></i> <span id="langIndicator">EN</span>
            </button>
        </div>
    </header>

    <!-- Search Area -->
    <div class="container mx-auto p-4 my-4 bg-gray-50 bg-opacity-90 rounded shadow">
        <div class="flex flex-col md:flex-row md:items-end gap-4">
            <div class="flex-grow relative md:w-3/5">
                <label for="searchInput" id="searchInputLabel" class="block text-sm font-medium text-gray-700 mb-1">Otsisõna</label>
                <input type="search" id="searchInput" class="p-2 border border-gray-300 bg-white bg-opacity-90 rounded-md w-full body-text" placeholder="Sisesta otsisõna...">
                <div id="suggestionsContainer" class="absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-[60] hidden max-h-60 overflow-y-auto text-sm">
                    <!-- Suggestions -->
                </div>
            </div>
            <div class="md:w-1/5">
                <label for="searchFieldSelector" id="searchFieldSelectorLabel" class="block text-sm font-medium text-gray-700 mb-1">Otsi väljal</label>
                <select id="searchFieldSelector" class="p-2 border border-gray-300 bg-white bg-opacity-90 rounded-md w-full text-sm h-[2.625rem]"> 
                    <option value="all">Kõik väljad</option>
                    <option value="title">Aine nimetus / Course name</option>
                    <option value="course_id">Kursuse kood</option>
                    <option value="keyword">Märksõna/Huviala</option>
                </select>
            </div>
            <div class="flex gap-2 mt-2 md:mt-0">
                <button id="searchButton" class="bg-tt-magenta text-white p-2 rounded hover:bg-opacity-80 headline text-sm flex-grow md:flex-grow-0 h-[2.625rem]">
                    <i class="fas fa-search mr-1"></i> <span id="searchButtonText">Otsi</span>
                </button>
                <button id="resetSearchButton" class="bg-gray-300 text-gray-700 p-2 rounded hover:bg-gray-400 headline text-sm flex-grow md:flex-grow-0 h-[2.625rem]">
                    <i class="fas fa-undo mr-1"></i> <span id="resetSearchButtonText">Lähtesta</span>
                </button>
            </div>
        </div>
    </div>


    <!-- Filter Panel -->
    <aside id="filterPanel" class="bg-gray-50 bg-opacity-95 p-4 shadow-lg fixed inset-y-0 left-0 transform -translate-x-full z-40 w-3/5 sm:w-2/5 md:w-1/3 lg:w-1/4 xl:w-1/5 overflow-y-auto mt-16 max-h-[calc(100%-4rem)] transition-transform duration-300 ease-in-out rounded-r-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 id="filtersTitle" class="text-xl headline tt-dark-blue">Filtrid</h2>
            <button id="closeFilterButton" class="text-tt-magenta hover:text-tt-dark-blue">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label for="schoolFilter" id="schoolFilterLabel" class="block text-sm font-medium tt-dark-blue headline">Kool</label>
                <select id="schoolFilter" class="mt-1 block w-full p-2 border-tt-grey-1 rounded-md shadow-sm focus:border-tt-magenta focus:ring focus:ring-tt-magenta focus:ring-opacity-50 text-sm">
                    <option value="">Kõik koolid</option>
                </select>
            </div>
            <div id="instituteFilterContainer">
                <label for="instituteFilter" id="instituteFilterLabel" class="block text-sm font-medium tt-dark-blue headline">Instituut</label>
                <select id="instituteFilter" class="mt-1 block w-full p-2 border-tt-grey-1 rounded-md shadow-sm focus:border-tt-magenta focus:ring focus:ring-tt-magenta focus:ring-opacity-50 text-sm" disabled>
                    <option value="">Kõik instituudid</option>
                </select>
            </div>
            <div>
                <label id="eapFilterLabel" class="block text-sm font-medium tt-dark-blue headline mb-1">EAP</label>
                <div class="space-y-1">
                    <label class="flex items-center text-sm">
                        <input type="radio" name="eapFilter" value="" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1" checked>
                        <span id="eapAllLabel" class="ml-2">Kõik</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="radio" name="eapFilter" value="3" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1">
                        <span id="eap3Label" class="ml-2">3 EAP</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="radio" name="eapFilter" value="6" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1">
                        <span id="eap6Label" class="ml-2">6 EAP</span>
                    </label>
                     <label class="flex items-center text-sm">
                        <input type="radio" name="eapFilter" value="9" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1">
                        <span id="eap9Label" class="ml-2">9 EAP</span>
                    </label>
                </div>
            </div>
            <div>
                <label for="assessmentFormFilter" id="assessmentFormFilterLabel" class="block text-sm font-medium tt-dark-blue headline">Hindamisvorm</label>
                <select id="assessmentFormFilter" class="mt-1 block w-full p-2 border-tt-grey-1 rounded-md shadow-sm focus:border-tt-magenta focus:ring focus:ring-tt-magenta focus:ring-opacity-50 text-sm">
                    <option value="">Kõik vormid</option>
                </select>
            </div>
            <div>
                <label id="languageFilterLabel" class="block text-sm font-medium tt-dark-blue headline mb-1">Õppekeel</label>
                <div class="space-y-1">
                    <label class="flex items-center text-sm">
                        <input type="radio" name="languageFilter" value="" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1" checked> 
                        <span id="langAllLabel" class="ml-2">Kõik</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="radio" name="languageFilter" value="et+en" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1">
                        <span id="langEtEnLabel" class="ml-2">Eesti ja Inglise keel</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="radio" name="languageFilter" value="et" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1">
                        <span id="langEtLabel" class="ml-2">Eesti keel</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="radio" name="languageFilter" value="en" class="focus:ring-tt-magenta h-4 w-4 text-tt-magenta border-tt-grey-1">
                        <span id="langEnLabel" class="ml-2">Inglise keel</span>
                    </label>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-4">
            <div id="resultsCounter" class="text-tt-dark-blue font-semibold"></div>
            <div id="activeFiltersDisplay">
                <!-- Active filter pills will be injected here -->
            </div>
        </div>
        <main id="courseList" class="w-full grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        </main>
    </div>
    
    <div id="loadingIndicator" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-5 rounded-lg shadow-xl flex flex-col items-center">
            <i class="fas fa-spinner fa-spin fa-3x tt-dark-blue"></i>
            <p id="loadingText" class="mt-2 text-tt-dark-blue body-text">Laen andmeid...</p>
        </div>
    </div>

    <script>
        // Ensure all DOM element variables are declared at the top
        const searchInputDOM = document.getElementById('searchInput');
        const searchFieldSelectorDOM = document.getElementById('searchFieldSelector');
        const searchButtonDOM = document.getElementById('searchButton');
        const resetSearchButtonDOM = document.getElementById('resetSearchButton');
        const suggestionsContainerDOM = document.getElementById('suggestionsContainer');
        const languageToggleDOM = document.getElementById('languageToggle');
        const courseListContainerDOM = document.getElementById('courseList');
        const activeFiltersDisplayDOM = document.getElementById('activeFiltersDisplay');
        const schoolFilterDOM = document.getElementById('schoolFilter');
        const instituteFilterDOM = document.getElementById('instituteFilter');
        const eapFilterRadiosDOM = document.querySelectorAll('input[name="eapFilter"]');
        const assessmentFormFilterDOM = document.getElementById('assessmentFormFilter');
        const languageFilterRadiosDOM = document.querySelectorAll('input[name="languageFilter"]');
        const loadingIndicatorDOM = document.getElementById('loadingIndicator');
        const filterPanelDOM = document.getElementById('filterPanel');
        const filterToggleButtonDOM = document.getElementById('filterToggleButton');
        const closeFilterButtonDOM = document.getElementById('closeFilterButton');
        const pageTitleDOM = document.getElementById('pageTitle'); // Added for completeness
        const resultsCounterDOM = document.getElementById('resultsCounter');

        let allCourses = [];
        let filteredCourses = [];
        let currentLanguage = 'et';
        let uniqueSearchableTerms = new Set();
        const MAX_SUGGESTIONS = 7;

        const uiTexts = {
            pageTitle: { et: 'TalTech kursused kevad 2025', en: 'TalTech Courses Spring 2025' },
            searchInputLabel: { et: 'Otsisõna', en: 'Search term' },
            searchPlaceholder: { et: 'Sisesta otsisõna...', en: 'Insert search word...' },
            searchFieldSelectorLabel: { et: 'Otsi väljal', en: 'Search in field' },
            searchField_all: { et: 'Kõik väljad', en: 'All fields' },
            searchField_title: { et: 'Aine nimetus / Course name', en: 'Course name' },
            searchField_course_id: { et: 'Kursuse kood', en: 'Course code' },
            searchField_keyword: { et: 'Märksõna/Huviala', en: 'Keyword/Interest' },
            searchButtonText: { et: 'Otsi', en: 'Search' },
            resetSearchButtonText: { et: 'Lähtesta', en: 'Reset' },
            resultsFoundText: { et: 'Leitud kursust', en: 'Found courses' },
            activeFiltersHeader: { et: 'Valitud filtrid:', en: 'Selected filters:'},
            clearAllFiltersButton: { et: 'Eemalda kõik filtrid', en: 'Clear all filters'},
            langIndicator: { et: 'EN', en: 'ET' },
            filterToggleButtonLabelOpen: { et: 'Ava filtrid', en: 'Open Filters' },
            filterToggleButtonLabelClose: { et: 'Sulge filtrid', en: 'Close Filters' },
            filtersTitle: { et: 'Filtrid', en: 'Filters' },
            schoolFilterLabel: { et: 'Kool', en: 'School' },
            allSchools: { et: 'Kõik koolid', en: 'All Schools' },
            instituteFilterLabel: { et: 'Instituut', en: 'Institute' },
            allInstitutes: { et: 'Kõik instituudid', en: 'All Institutes' },
            selectInstitute: { et: 'Vali instituut', en: 'Select Institute' },
            eapFilterLabel: { et: 'EAP', en: 'ECTS (Credits)' },
            eapAllLabel: { et: 'Kõik', en: 'All' },
            eap3Label: { et: '3 EAP', en: '3 ECTS' },
            eap6Label: { et: '6 EAP', en: '6 ECTS' },
            eap9Label: { et: '9 EAP', en: '9 ECTS' },
            assessmentFormFilterLabel: { et: 'Hindamisvorm', en: 'Assessment Form' },
            allAssessmentForms: { et: 'Kõik vormid', en: 'All Forms' },
            languageFilterLabel: { et: 'Õppekeel', en: 'Teaching Language' },
            langAllLabel: { et: 'Kõik', en: 'All' },
            langEtEnLabel: { et: 'Eesti ja Inglise keel', en: 'Estonian and English' }, 
            langEtLabel: { et: 'Eesti keel', en: 'Estonian' },
            langEnLabel: { et: 'Inglise keel', en: 'English' },
            eapTooltip: { et: 'EAP', en: 'ECTS' },
            eapFull: { et: 'Euroopa ainepunktisüsteemi ainepunktid', en: 'European Credit Transfer and Accumulation System credits'},
            semester: { et: 'Semester', en: 'Semester' },
            assessment: { et: 'Hindamisvorm', en: 'Assessment Form' },
            objectives: { et: 'Eesmärgid', en: 'Objectives' },
            learningOutcomes: { et: 'Õpiväljundid', en: 'Learning Outcomes' },
            literature: { et: 'Kirjandus', en: 'Literature' },
            courseCardLink: { et: 'Kursuse kaart', en: 'Course Card' },
            timetableLink: { et: 'Tunniplaan', en: 'Timetable' },
            showMore: { et: 'Näita rohkem', en: 'Show more' },
            showLess: { et: 'Näita vähem', en: 'Show less' },
            noCoursesFound: { et: 'Vastavaid kursuseid ei leitud.', en: 'No matching courses found.' },
            loadingText: { et: 'Laen andmeid...', en: 'Loading data...' },
        };

        let activeFilters = {
            searchTerm: '',
            searchFieldType: 'all', 
            school: '',
            institute: '',
            eap: '',
            assessmentForm: '',
            teachingLanguage: '', 
        };
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function setLanguage(lang) {
            console.log("Setting language to:", lang);
            currentLanguage = lang;
            document.documentElement.lang = lang;
            hideSuggestions();
            updateAllUITexts();
            populateFilterOptions(); 
            applyAllFiltersAndRenderDisplay(); 
        }

        function updateAllUITexts() {
            console.log("Updating UI texts for language:", currentLanguage);
            Object.keys(uiTexts).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                     if (element.id === 'searchInput' && key === 'searchPlaceholder') {
                        element.placeholder = uiTexts[key][currentLanguage];
                    } else {
                         element.textContent = uiTexts[key][currentLanguage];
                    }
                }
            });
            if (searchFieldSelectorDOM) {
                searchFieldSelectorDOM.options[0].textContent = uiTexts.searchField_all[currentLanguage];
                searchFieldSelectorDOM.options[1].textContent = uiTexts.searchField_title[currentLanguage];
                searchFieldSelectorDOM.options[2].textContent = uiTexts.searchField_course_id[currentLanguage];
                searchFieldSelectorDOM.options[3].textContent = uiTexts.searchField_keyword[currentLanguage];
            }
            
            const langIndicator = document.getElementById('langIndicator');
            if (langIndicator) langIndicator.textContent = uiTexts.langIndicator[currentLanguage === 'et' ? 'en' : 'et'];


            const filterPanelIsOpen = filterPanelDOM ? filterPanelDOM.classList.contains('filter-drawer-open') : false;
            if (filterToggleButtonDOM) filterToggleButtonDOM.setAttribute('aria-label', uiTexts[filterPanelIsOpen ? 'filterToggleButtonLabelClose' : 'filterToggleButtonLabelOpen'][currentLanguage]);
        }

        function createCourseCardHTML(course) {
            const nameEt = course.name_et || (currentLanguage === 'et' ? 'Nimetu kursus' : 'Untitled Course');
            const nameEn = course.name_en || (currentLanguage === 'en' ? 'Untitled Course' : 'Nimetu kursus');
            const objectivesText = currentLanguage === 'et' ? course.objectives_et : course.objectives_en;
            const learningOutcomesText = currentLanguage === 'et' ? course.learning_outcomes_et : course.learning_outcomes_en;
            const descriptionShort = currentLanguage === 'et' ? course.description_short_et : course.description_short_en;
            const literature = currentLanguage === 'et' ? course.literature_et : (course.literature_en || course.literature_et);
            const schoolName = course.school_name;
            const assessmentFormText = course.assessment_form_et; 
            const courseId = course.id || ''; 

            let langDisplayTag = '';
            const isEt = course.keel_et === "1"; 
            const isEn = course.keel_en === "1"; 
            if (isEt && isEn) langDisplayTag = 'ET + EN';
            else if (isEt) langDisplayTag = 'ET';
            else if (isEn) langDisplayTag = 'EN';

            const listify = (text) => {
                if (!text) return `<li>${currentLanguage === 'et' ? 'Andmed puuduvad' : 'Not available'}</li>`;
                const items = text.split(/\n(?=- )/).map(item => item.trim()).filter(item => item.length > 0);
                if (items.length > 0) {
                    return items.map(item => `<li>${item.startsWith('- ') ? item.substring(2) : item}</li>`).join('');
                }
                return text.split('\n').map(item => item.trim()).filter(item => item.length > 0).map(item => `<li>${item}</li>`).join('');
            };
            
            const objectivesList = listify(objectivesText);
            const learningOutcomesList = listify(learningOutcomesText);
            const literatureList = listify(literature);

            return `
                <div class="bg-white rounded-lg shadow-md border border-tt-grey-1 overflow-hidden flex flex-col">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-1">
                            <h2 class="text-lg proxima-nova-bold uppercase flex-grow pr-2">
                                ${course.course_card_link ? `<a href="${course.course_card_link}" target="_blank" class="tt-magenta hover:underline">${nameEt}</a>` : `<span class="tt-dark-blue">${nameEt}</span>`}
                            </h2>
                            ${courseId ? `<span class="text-md proxima-nova-bold tt-dark-blue whitespace-nowrap">${courseId}</span>` : ''}
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                ${nameEt.toLowerCase() !== nameEn.toLowerCase() ? `<h3 class="text-md tt-grey-1">${nameEn}</h3>` : ''}
                            </div>
                            ${course.timetable_link ? `<a href="${course.timetable_link}" target="_blank" class="text-tt-magenta text-sm hover:underline"><i class="fas fa-calendar-alt mr-1"></i>${uiTexts.timetableLink[currentLanguage]}</a>` : ''}
                        </div>
                        
                        <div class="mb-3 flex flex-wrap gap-2 items-center">
                            ${schoolName ? `<span class="inline-block bg-gray-200 text-gray-700 text-xs font-semibold px-2.5 py-0.5 rounded">${schoolName}</span>` : ''}
                            ${langDisplayTag ? `<span class="inline-block bg-tt-light-blue text-white text-xs font-semibold px-2.5 py-0.5 rounded">${langDisplayTag}</span>` : ''}
                            <span class="inline-block bg-gray-200 text-tt-dark-blue text-xs font-semibold px-2.5 py-0.5 rounded tooltip">
                                ${course.eap} ${uiTexts.eapTooltip[currentLanguage]}
                                <span class="tooltiptext body-text">${course.eap} ${uiTexts.eapFull[currentLanguage]}</span>
                            </span>
                        </div>
                        <p class="text-sm text-gray-700 mb-3 body-text h-20 overflow-y-auto">${descriptionShort || (currentLanguage === 'et' ? 'Kirjeldus puudub' : 'No description')}</p>
                    </div>
                    <div class="px-4 pb-4 mt-auto">
                        <button class="expand-button text-tt-magenta hover:text-tt-dark-blue text-sm proxima-nova-bold" aria-expanded="false" aria-controls="details-${course.id}">
                            <i class="fas fa-plus" data-show="fa-plus" data-hide="fa-minus"></i>
                        </button>
                    </div>
                    <div id="details-${course.id}" class="expandable-content hidden p-4 border-t border-tt-grey-1 bg-gray-50">
                        <div class="mb-2 text-sm tt-grey-1">
                           ${uiTexts.semester[currentLanguage]}: ${course.semester_et || (currentLanguage === 'et' ? 'Puudub' : 'N/A')} | 
                           ${uiTexts.assessment[currentLanguage]}: ${assessmentFormText || (currentLanguage === 'et' ? 'Puudub' : 'N/A')}
                        </div>
                        <h4 class="font-semibold tt-dark-blue mb-1 headline">${uiTexts.objectives[currentLanguage]}</h4>
                        <ul class="list-disc list-inside text-sm mb-3 body-text">${objectivesList}</ul>
                        
                        <h4 class="font-semibold tt-dark-blue mb-1 headline">${uiTexts.learningOutcomes[currentLanguage]}</h4>
                        <ul class="list-disc list-inside text-sm mb-3 body-text">${learningOutcomesList}</ul>
                        
                        ${literature ? `
                        <h4 class="font-semibold tt-dark-blue mb-1 headline">${uiTexts.literature[currentLanguage]}</h4>
                        <ul class="list-disc list-inside text-sm mb-3 body-text">${literatureList}</ul>` : ''}
                        
                        <!-- Links removed from here and moved to the top section -->
                        
                    </div>
                </div>
            `;
        }

        function renderCourses(coursesToRender) {
            if (!courseListContainerDOM) {
                console.error("courseListContainerDOM is not found!");
                return;
            }
            courseListContainerDOM.innerHTML = '';
            
            // Update results counter
            if (resultsCounterDOM) {
                if (coursesToRender.length === 0) {
                    resultsCounterDOM.textContent = currentLanguage === 'et' ? 'Leitud 0 kursust' : 'Found 0 courses';
                } else {
                    resultsCounterDOM.textContent = `${coursesToRender.length} ${uiTexts.resultsFoundText[currentLanguage]}`;
                }
            }
            
            if (coursesToRender.length === 0) {
                courseListContainerDOM.innerHTML = `<p class="text-center text-tt-grey-1 col-span-full">${uiTexts.noCoursesFound[currentLanguage]}</p>`;
                return;
            }
            coursesToRender.forEach(course => {
                const cardHTML = createCourseCardHTML(course);
                courseListContainerDOM.insertAdjacentHTML('beforeend', cardHTML);
            });
            addExpandButtonListeners();
            document.querySelectorAll('.expand-button i').forEach(icon => {
                const parentButton = icon.closest('button');
                if (!parentButton) return;
                const content = parentButton.closest('div.flex-col').querySelector('.expandable-content');
                if (!content) return;
                const isHidden = content.classList.contains('hidden');
                if (!isHidden) {
                    icon.classList.remove(icon.dataset.show);
                    icon.classList.add(icon.dataset.hide);
                } else {
                    icon.classList.remove(icon.dataset.hide);
                    icon.classList.add(icon.dataset.show);
                }
            });
        }
        
        function addExpandButtonListeners() {
            document.querySelectorAll('.expand-button').forEach(button => {
                if (button.dataset.listenerAttached) return;
                button.addEventListener('click', () => {
                    const content = button.closest('div.flex-col').querySelector('.expandable-content');
                    if (!content) return;
                    const icon = button.querySelector('i');
                    const span = button.querySelector('span');
                    const isCurrentlyHidden = content.classList.contains('hidden');
                    
                    content.classList.toggle('hidden');
                    button.setAttribute('aria-expanded', String(!isCurrentlyHidden));

                    if (isCurrentlyHidden) { 
                        icon.classList.remove(icon.dataset.show); 
                        icon.classList.add(icon.dataset.hide);
                    } else { 
                        icon.classList.remove(icon.dataset.hide); 
                        icon.classList.add(icon.dataset.show);
                    }
                });
                button.dataset.listenerAttached = 'true';
            });
        }

        function applyAllFiltersAndRenderDisplay() {
            applyAllFilters();
            renderActiveFiltersDisplay();
        }
        const debouncedApplyAllFiltersAndRenderDisplay = debounce(applyAllFiltersAndRenderDisplay, 300);

        function applyAllFilters() {
            if (loadingIndicatorDOM) loadingIndicatorDOM.classList.remove('hidden');
            setTimeout(() => {
                let tempFilteredCourses = [...allCourses];
                const searchTermLower = activeFilters.searchTerm.toLowerCase();

                if (activeFilters.searchTerm) {
                    tempFilteredCourses = tempFilteredCourses.filter(course => {
                        switch (activeFilters.searchFieldType) {
                            case 'title':
                                return (course.name_et && course.name_et.toLowerCase().includes(searchTermLower)) ||
                                       (course.name_en && course.name_en.toLowerCase().includes(searchTermLower));
                            case 'course_id':
                                return course.id && course.id.toLowerCase().includes(searchTermLower);
                            case 'keyword':
                                return (course.keywords_et && course.keywords_et.some(kw => kw.toLowerCase().includes(searchTermLower))) ||
                                       (course.keywords_en && course.keywords_en.some(kw => kw.toLowerCase().includes(searchTermLower))) ||
                                       (course.interests && course.interests.some(i => i.toLowerCase().includes(searchTermLower)));
                            case 'all':
                            default:
                                return (course.id && course.id.toLowerCase().includes(searchTermLower)) ||
                                       (course.name_et && course.name_et.toLowerCase().includes(searchTermLower)) ||
                                       (course.name_en && course.name_en.toLowerCase().includes(searchTermLower)) ||
                                       (course.description_short_et && course.description_short_et.toLowerCase().includes(searchTermLower)) ||
                                       (course.description_short_en && course.description_short_en.toLowerCase().includes(searchTermLower)) ||
                                       (course.keywords_et && course.keywords_et.some(kw => kw.toLowerCase().includes(searchTermLower))) ||
                                       (course.keywords_en && course.keywords_en.some(kw => kw.toLowerCase().includes(searchTermLower))) ||
                                       (course.interests && course.interests.some(i => i.toLowerCase().includes(searchTermLower)));
                        }
                    });
                }
                if (activeFilters.school) {
                    tempFilteredCourses = tempFilteredCourses.filter(course => course.school_code === activeFilters.school);
                }
                if (activeFilters.institute) {
                    tempFilteredCourses = tempFilteredCourses.filter(course => course.institute_name === activeFilters.institute);
                }
                if (activeFilters.eap) { 
                    const eapValue = parseInt(activeFilters.eap);
                    tempFilteredCourses = tempFilteredCourses.filter(course => course.eap === eapValue);
                }
                if(activeFilters.assessmentForm) {
                    tempFilteredCourses = tempFilteredCourses.filter(course => course.assessment_form_et === activeFilters.assessmentForm);
                }
                
                const langFilter = activeFilters.teachingLanguage;
                if (langFilter === 'et') { 
                    tempFilteredCourses = tempFilteredCourses.filter(course => course.keel_et === "1" && course.keel_en !== "1");
                } else if (langFilter === 'en') { 
                    tempFilteredCourses = tempFilteredCourses.filter(course => course.keel_en === "1" && course.keel_et !== "1");
                } else if (langFilter === 'et+en') { 
                    tempFilteredCourses = tempFilteredCourses.filter(course => course.keel_et === "1" && course.keel_en === "1");
                } 
                
                filteredCourses = tempFilteredCourses;
                renderCourses(filteredCourses);
                if (loadingIndicatorDOM) loadingIndicatorDOM.classList.add('hidden');
            }, 20);
        }
        
        function populateFilterOptions() {
            if (!schoolFilterDOM || !assessmentFormFilterDOM) {
                console.error("Filter select elements not found for populating.");
                return;
            }
            const schools = [...new Map(allCourses.map(course => [course.school_code, {code: course.school_code, name: course.school_name}])).values()];
            const currentSchoolValue = schoolFilterDOM.value;
            schoolFilterDOM.innerHTML = `<option value="">${uiTexts.allSchools[currentLanguage]}</option>`; 
            schools.sort((a,b) => (a.name || "").localeCompare(b.name || "")).forEach(school => {
                if(school.code && school.name) { 
                    schoolFilterDOM.add(new Option(school.name, school.code));
                }
            });
            schoolFilterDOM.value = currentSchoolValue;
            updateInstituteFilter(currentSchoolValue);

            const assessmentForms = [...new Set(allCourses.map(c => c.assessment_form_et).filter(Boolean))].sort(
                (a, b) => a.localeCompare(b, currentLanguage === 'et' ? 'et' : 'en', { sensitivity: 'base' })
            );
            const currentAssessmentFormValue = assessmentFormFilterDOM.value;
            assessmentFormFilterDOM.innerHTML = `<option value="">${uiTexts.allAssessmentForms[currentLanguage]}</option>`;
            assessmentForms.forEach(form => {
                assessmentFormFilterDOM.add(new Option(form, form));
            });
            assessmentFormFilterDOM.value = currentAssessmentFormValue;
        }

        function updateInstituteFilter(selectedSchoolCode) {
            if (!instituteFilterDOM) {
                console.error("Institute filter DOM not found.");
                return;
            }
            const currentInstituteValue = instituteFilterDOM.value;
            instituteFilterDOM.innerHTML = `<option value="">${selectedSchoolCode ? uiTexts.selectInstitute[currentLanguage] : uiTexts.allInstitutes[currentLanguage]}</option>`;
            
            if (selectedSchoolCode) {
                const institutesForSchool = [...new Set(
                    allCourses
                        .filter(course => course.school_code === selectedSchoolCode && course.institute_name)
                        .map(course => course.institute_name)
                )].sort(
                     (a, b) => a.localeCompare(b, currentLanguage === 'et' ? 'et' : 'en', { sensitivity: 'base' })
                );

                institutesForSchool.forEach(institute => {
                    instituteFilterDOM.add(new Option(institute, institute));
                });
                instituteFilterDOM.disabled = institutesForSchool.length === 0;
                if (institutesForSchool.includes(currentInstituteValue)) {
                    instituteFilterDOM.value = currentInstituteValue;
                } else {
                    activeFilters.institute = ''; 
                    instituteFilterDOM.value = "";
                }
            } else { 
                const allInstitutesList = [...new Set(allCourses.map(course => course.institute_name).filter(Boolean))].sort(
                     (a, b) => a.localeCompare(b, currentLanguage === 'et' ? 'et' : 'en', { sensitivity: 'base' })
                );
                 allInstitutesList.forEach(institute => {
                    instituteFilterDOM.add(new Option(institute, institute));
                });
                instituteFilterDOM.disabled = false; 
                if (allInstitutesList.includes(currentInstituteValue)) {
                     instituteFilterDOM.value = currentInstituteValue;
                } else {
                     activeFilters.institute = '';
                     instituteFilterDOM.value = "";
                }
            }
        }
        
        function compileUniqueSearchableTerms() {
            uniqueSearchableTerms.clear();
            allCourses.forEach(course => {
                if (course.id) uniqueSearchableTerms.add(course.id);
                if (course.name_et) uniqueSearchableTerms.add(course.name_et);
                if (course.name_en) uniqueSearchableTerms.add(course.name_en);
                (course.keywords_et || []).forEach(kw => uniqueSearchableTerms.add(kw));
                (course.keywords_en || []).forEach(kw => uniqueSearchableTerms.add(kw));
                (course.interests || []).forEach(interest => uniqueSearchableTerms.add(interest));
            });
            console.log("Compiled unique searchable terms:", uniqueSearchableTerms.size);
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function handleSearchInput() {
            const term = searchInputDOM.value.trim();
            activeFilters.searchTerm = searchInputDOM.value; 
            activeFilters.searchFieldType = searchFieldSelectorDOM.value;

            if (term.length < 2) { 
                hideSuggestions();
                debouncedApplyAllFiltersAndRenderDisplay(); 
                return;
            }
            const termLower = term.toLowerCase();
            const matchedSuggestions = [];
            for (const sTerm of uniqueSearchableTerms) { 
                if (sTerm.toLowerCase().includes(termLower)) {
                    matchedSuggestions.push(sTerm);
                }
                if (matchedSuggestions.length >= MAX_SUGGESTIONS * 10) break;
            }
            
            const prioritizedSuggestions = matchedSuggestions
                .sort((a, b) => { 
                    const aLower = a.toLowerCase();
                    const bLower = b.toLowerCase();
                    const aStarts = aLower.startsWith(termLower);
                    const bStarts = bLower.startsWith(termLower);

                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    if (aLower.includes(termLower) && bLower.includes(termLower)) {
                        if (aLower.length < bLower.length) return -1;
                        if (aLower.length > bLower.length) return 1;
                    }
                    return aLower.localeCompare(bLower);
                })
                .slice(0, MAX_SUGGESTIONS);

            if (prioritizedSuggestions.length > 0) {
                renderSuggestions(prioritizedSuggestions, term);
            } else {
                hideSuggestions();
            }
            debouncedApplyAllFiltersAndRenderDisplay();
        }

        function renderSuggestions(suggestions, searchTerm) {
            if (!suggestionsContainerDOM) return;
            suggestionsContainerDOM.innerHTML = '';
            if (suggestions.length === 0) {
                hideSuggestions();
                return;
            }
            const ul = document.createElement('ul');
            const escapedSearchTerm = escapeRegExp(searchTerm);
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');

            suggestions.forEach(suggestionText => {
                const li = document.createElement('li');
                let highlightedHTML = suggestionText;
                if (searchTerm.length > 0) { 
                    highlightedHTML = suggestionText.replace(regex, `<span class="suggestion-highlight">$1</span>`);
                }
                li.innerHTML = highlightedHTML; 
                li.className = 'p-2 hover:bg-tt-grey-2 cursor-pointer text-sm body-text';
                li.addEventListener('click', () => {
                    searchInputDOM.value = suggestionText; 
                    activeFilters.searchTerm = suggestionText;
                    activeFilters.searchFieldType = searchFieldSelectorDOM.value; 
                    hideSuggestions();
                    applyAllFiltersAndRenderDisplay(); 
                });
                ul.appendChild(li);
            });
            suggestionsContainerDOM.appendChild(ul);
            suggestionsContainerDOM.classList.remove('hidden');
        }

        function hideSuggestions() {
            if (suggestionsContainerDOM) {
                suggestionsContainerDOM.classList.add('hidden');
                suggestionsContainerDOM.innerHTML = '';
            }
        }

        function renderActiveFiltersDisplay() {
            if (!activeFiltersDisplayDOM) return;
            activeFiltersDisplayDOM.innerHTML = '';
            let hasActiveFilter = false;
            const pillsHTML = [];

            if (activeFilters.searchTerm) {
                hasActiveFilter = true;
                let fieldLabel = uiTexts[`searchField_${activeFilters.searchFieldType}`] ? uiTexts[`searchField_${activeFilters.searchFieldType}`][currentLanguage] : activeFilters.searchFieldType;
                pillsHTML.push(`<span class="filter-pill">${fieldLabel}: "${activeFilters.searchTerm}" 
                                <button class="filter-pill-remove" data-filtertype="searchTerm" aria-label="Eemalda otsingusõna">&times;</button>
                               </span>`);
            }
            if (activeFilters.school && schoolFilterDOM) {
                hasActiveFilter = true;
                const schoolOption = Array.from(schoolFilterDOM.options).find(opt => opt.value === activeFilters.school);
                const schoolName = schoolOption ? schoolOption.textContent : activeFilters.school;
                pillsHTML.push(`<span class="filter-pill">${uiTexts.schoolFilterLabel[currentLanguage]}: ${schoolName} 
                                <button class="filter-pill-remove" data-filtertype="school" aria-label="Eemalda kooli filter">&times;</button>
                               </span>`);
            }
            if (activeFilters.institute && instituteFilterDOM) {
                 hasActiveFilter = true;
                 const instituteOption = Array.from(instituteFilterDOM.options).find(opt => opt.value === activeFilters.institute);
                 const instituteName = instituteOption ? instituteOption.textContent : activeFilters.institute;
                 pillsHTML.push(`<span class="filter-pill">${uiTexts.instituteFilterLabel[currentLanguage]}: ${instituteName}
                                 <button class="filter-pill-remove" data-filtertype="institute" aria-label="Eemalda instituudi filter">&times;</button>
                                </span>`);
            }
            if (activeFilters.eap) {
                hasActiveFilter = true;
                pillsHTML.push(`<span class="filter-pill">${uiTexts.eapFilterLabel[currentLanguage]}: ${activeFilters.eap} EAP
                                <button class="filter-pill-remove" data-filtertype="eap" aria-label="Eemalda EAP filter">&times;</button>
                               </span>`);
            }
            if (activeFilters.assessmentForm && assessmentFormFilterDOM) {
                hasActiveFilter = true;
                 const formOption = Array.from(assessmentFormFilterDOM.options).find(opt => opt.value === activeFilters.assessmentForm);
                 const formName = formOption ? formOption.textContent : activeFilters.assessmentForm;
                pillsHTML.push(`<span class="filter-pill">${uiTexts.assessmentFormFilterLabel[currentLanguage]}: ${formName}
                                <button class="filter-pill-remove" data-filtertype="assessmentForm" aria-label="Eemalda hindamisvormi filter">&times;</button>
                               </span>`);
            }
            if (activeFilters.teachingLanguage) { 
                hasActiveFilter = true;
                let langLabel = '';
                if (activeFilters.teachingLanguage === 'et') langLabel = uiTexts.langEtLabel[currentLanguage];
                else if (activeFilters.teachingLanguage === 'en') langLabel = uiTexts.langEnLabel[currentLanguage];
                else if (activeFilters.teachingLanguage === 'et+en') langLabel = uiTexts.langEtEnLabel[currentLanguage];
                // No need for fallback to "All" here, as "" means no language filter active for display
                
                if (activeFilters.teachingLanguage !== "") { // Only show pill if not "All"
                    pillsHTML.push(`<span class="filter-pill">${uiTexts.languageFilterLabel[currentLanguage]}: ${langLabel}
                                    <button class="filter-pill-remove" data-filtertype="teachingLanguage" aria-label="Eemalda õppekeele filter">&times;</button>
                                </span>`);
                } else { // If it was the only active filter, and now it's "" (All), recalculate hasActiveFilter
                    hasActiveFilter = Object.values(activeFilters).some((val, index) => {
                        // Check if any other filter (not teachingLanguage, which is now "") is active
                        return index !== Object.keys(activeFilters).indexOf('teachingLanguage') && val !== '' && val !== 'all';
                    });
                }
            }

            if (hasActiveFilter) {
                activeFiltersDisplayDOM.innerHTML = `
                    <div class="flex flex-wrap items-center mb-2">
                        <strong class="mr-2 body-text">${uiTexts.activeFiltersHeader[currentLanguage]}</strong>
                        ${pillsHTML.join('')}
                        <button id="clearAllFiltersButton" class="text-sm text-tt-magenta hover:underline ml-2 body-text">
                            ${uiTexts.clearAllFiltersButton[currentLanguage]}
                        </button>
                    </div>`;
                
                document.querySelectorAll('.filter-pill-remove').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const filterType = e.currentTarget.dataset.filtertype;
                        removeFilter(filterType);
                    });
                });
                const clearAllBtn = document.getElementById('clearAllFiltersButton');
                if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllFilters);
            }
        }

        function removeFilter(filterType) {
            switch(filterType) {
                case 'searchTerm':
                    activeFilters.searchTerm = '';
                    if (searchInputDOM) searchInputDOM.value = '';
                    break;
                case 'school':
                    activeFilters.school = '';
                    if (schoolFilterDOM) schoolFilterDOM.value = '';
                    activeFilters.institute = ''; 
                    if (instituteFilterDOM) instituteFilterDOM.value = '';
                    updateInstituteFilter('');
                    break;
                case 'institute':
                    activeFilters.institute = '';
                    if (instituteFilterDOM) instituteFilterDOM.value = '';
                    break;
                case 'eap':
                    activeFilters.eap = '';
                    const eapAllRadio = document.querySelector('input[name="eapFilter"][value=""]');
                    if (eapAllRadio) eapAllRadio.checked = true;
                    break;
                case 'assessmentForm':
                    activeFilters.assessmentForm = '';
                    if (assessmentFormFilterDOM) assessmentFormFilterDOM.value = '';
                    break;
                case 'teachingLanguage':
                    activeFilters.teachingLanguage = ''; 
                    const langAllRadio = document.querySelector('input[name="languageFilter"][value=""]');
                    if (langAllRadio) langAllRadio.checked = true;
                    break;
            }
            applyAllFiltersAndRenderDisplay();
        }

        function clearAllFilters() {
            activeFilters = {
                searchTerm: '', searchFieldType: 'all', school: '', institute: '',
                eap: '', assessmentForm: '', teachingLanguage: '',
            };
            if (searchInputDOM) searchInputDOM.value = '';
            if (searchFieldSelectorDOM) searchFieldSelectorDOM.value = 'all';
            if (schoolFilterDOM) schoolFilterDOM.value = '';
            if (instituteFilterDOM) instituteFilterDOM.value = '';
            updateInstituteFilter('');
            const eapAllRadio = document.querySelector('input[name="eapFilter"][value=""]');
            if (eapAllRadio) eapAllRadio.checked = true;
            if (assessmentFormFilterDOM) assessmentFormFilterDOM.value = '';
            const langAllRadio = document.querySelector('input[name="languageFilter"][value=""]');
            if (langAllRadio) langAllRadio.checked = true;

            applyAllFiltersAndRenderDisplay();
        }
        
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            if (languageToggleDOM) languageToggleDOM.addEventListener('click', () => {
                setLanguage(currentLanguage === 'et' ? 'en' : 'et');
            });

            if (searchInputDOM) {
                searchInputDOM.addEventListener('input', debounce(handleSearchInput, 250)); 
                searchInputDOM.addEventListener('focus', () => {
                    if (searchInputDOM.value.trim().length >= 2) handleSearchInput();
                });
            }
            if (searchFieldSelectorDOM) searchFieldSelectorDOM.addEventListener('change', (e) => {
                activeFilters.searchFieldType = e.target.value;
                if (activeFilters.searchTerm) { 
                    applyAllFiltersAndRenderDisplay();
                }
            });
            if (searchButtonDOM) searchButtonDOM.addEventListener('click', () => {
                activeFilters.searchTerm = searchInputDOM ? searchInputDOM.value : ""; 
                activeFilters.searchFieldType = searchFieldSelectorDOM ? searchFieldSelectorDOM.value : "all"; 
                hideSuggestions();
                applyAllFiltersAndRenderDisplay();
            });
            if (resetSearchButtonDOM) resetSearchButtonDOM.addEventListener('click', () => {
                if (searchInputDOM) searchInputDOM.value = '';
                if (searchFieldSelectorDOM) searchFieldSelectorDOM.value = 'all';
                activeFilters.searchTerm = '';
                activeFilters.searchFieldType = 'all';
                hideSuggestions();
                applyAllFiltersAndRenderDisplay();
            });
            
            document.addEventListener('click', (e) => {
                if (searchInputDOM && suggestionsContainerDOM && searchButtonDOM &&
                    !searchInputDOM.contains(e.target) && 
                    !suggestionsContainerDOM.contains(e.target) && 
                    !searchButtonDOM.contains(e.target)) {
                    hideSuggestions();
                }
            });

            if (schoolFilterDOM) schoolFilterDOM.addEventListener('change', (e) => {
                activeFilters.school = e.target.value;
                activeFilters.institute = ''; 
                updateInstituteFilter(activeFilters.school);
                applyAllFiltersAndRenderDisplay();
            });
            if (instituteFilterDOM) instituteFilterDOM.addEventListener('change', (e) => {
                activeFilters.institute = e.target.value;
                applyAllFiltersAndRenderDisplay();
            });
            
            eapFilterRadiosDOM.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    activeFilters.eap = e.target.value; 
                    applyAllFiltersAndRenderDisplay();
                });
            });
            if (assessmentFormFilterDOM) assessmentFormFilterDOM.addEventListener('change', (e) => {
                activeFilters.assessmentForm = e.target.value;
                applyAllFiltersAndRenderDisplay();
            });
            languageFilterRadiosDOM.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    activeFilters.teachingLanguage = e.target.value;
                    applyAllFiltersAndRenderDisplay();
                });
            });

            if (filterToggleButtonDOM) filterToggleButtonDOM.addEventListener('click', () => {
                if (!filterPanelDOM) return;
                const isOpen = filterPanelDOM.classList.toggle('filter-drawer-open');
                const icon = filterToggleButtonDOM.querySelector('i');
                if (isOpen) {
                    icon.classList.remove('fa-bars'); icon.classList.add('fa-times');
                    filterToggleButtonDOM.setAttribute('aria-label', uiTexts.filterToggleButtonLabelClose[currentLanguage]);
                } else {
                    icon.classList.remove('fa-times'); icon.classList.add('fa-bars');
                    filterToggleButtonDOM.setAttribute('aria-label', uiTexts.filterToggleButtonLabelOpen[currentLanguage]);
                }
            });
            if (closeFilterButtonDOM) closeFilterButtonDOM.addEventListener('click', () => {
                 if (!filterPanelDOM || !filterToggleButtonDOM) return;
                filterPanelDOM.classList.remove('filter-drawer-open');
                const icon = filterToggleButtonDOM.querySelector('i');
                icon.classList.remove('fa-times'); icon.classList.add('fa-bars');
                filterToggleButtonDOM.setAttribute('aria-label', uiTexts.filterToggleButtonLabelOpen[currentLanguage]);
            });
             console.log("Event listeners setup complete.");
        }

        async function initializeApp() {
            console.log("Initializing app...");
            if (loadingIndicatorDOM) loadingIndicatorDOM.classList.remove('hidden');
            try {
                const response = await fetch('courses.json'); // MAKE SURE THIS FILE EXISTS AND IS ACCESSIBLE
                console.log("Fetch response status:", response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}, Nimi: courses.json`);
                }
                allCourses = await response.json();
                console.log("Courses loaded:", allCourses.length);

                allCourses.forEach(course => {
                    if (course.interests && Array.isArray(course.interests)) {
                        course.interests = course.interests.map(interest => interest === "History" ? "Law" : interest);
                        course.interests = [...new Set(course.interests)]; 
                    }
                });

                activeFilters.teachingLanguage = ""; 
                activeFilters.searchTerm = "";
                activeFilters.searchFieldType = "all";

                compileUniqueSearchableTerms();
                filteredCourses = [...allCourses]; 
                
                // Set language first, which will trigger UI updates and filtering
                setLanguage('et'); 
                setupEventListeners(); // Setup listeners after initial data load and language set

            } catch (error) {
                console.error("Could not load or initialize courses:", error);
                if (courseListContainerDOM) {
                     courseListContainerDOM.innerHTML = `<p class="text-red-500 text-center col-span-full">Viga kursuste laadimisel (${error.message}). Palun kontrolli, et fail "courses.json" on olemas ja proovi hiljem uuesti.</p>`;
                } else {
                    alert(`Viga kursuste laadimisel (${error.message}). Palun kontrolli, et fail "courses.json" on olemas ja proovi hiljem uuesti.`);
                }
            } finally {
                 if (loadingIndicatorDOM) loadingIndicatorDOM.classList.add('hidden');
                 console.log("App initialization finished.");
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
